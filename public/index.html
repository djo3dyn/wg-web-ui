<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WireGuard Web UI</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: system-ui, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  margin:0;
  padding:20px;
}
h1,h2,h3 { margin-top:0 }
.card {
  background:#020617;
  border:1px solid #1e293b;
  border-radius:8px;
  padding:16px;
  margin-bottom:20px;
}
table {
  width:100%;
  border-collapse:collapse;
}
th,td {
  border-bottom:1px solid #1e293b;
  padding:8px;
  font-size:14px;
}
th { color:#93c5fd }
input,textarea,button {
  background:#020617;
  border:1px solid #334155;
  color:#e5e7eb;
  border-radius:4px;
  padding:6px;
}
button { cursor:pointer }
.ok { border-color:#22c55e; color:#22c55e }
.warn { border-color:#f59e0b; color:#f59e0b }
.danger { border-color:#ef4444; color:#ef4444 }
.row { display:flex; gap:8px; flex-wrap:wrap }
.muted { color:#64748b; font-size:12px }

/* popup */
.popup {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  z-index:999;
}
.popup-box {
  background:#020617;
  border:1px solid #1e293b;
  border-radius:8px;
  width:360px;
  margin:10% auto;
  padding:16px;
}

.topbar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 14px;
  background:#020617;
  border-bottom:1px solid #1e293b;
}
.topbar .title{
  font-size:16px;
  font-weight:bold;
}
.topbar .actions button{
  margin-left:6px;
}
button.danger{
  background:#7f1d1d;
}

table th{
  text-align:left;
}

</style>
</head>

<body>

<h1>üîê WireGuard Web UI</h1>

<!-- SERVER -->
<div class="card">
  <h2>Server Status</h2>
  <div id="serverStatus">Loading...</div>
  <div class="row" style="margin-top:8px">
    <button class="warn" onclick="restartServer()">Restart</button>
  </div>
</div>

<div class="card">
  <h2>WireGuard Admin</h2>
  <div class="actions">
    <button onclick="downloadPeerBackup()">Backup Peers</button>
    <button onclick="restorePeerBackup()">Restore Peers</button>
    <input type="file" id="peerRestoreFile" accept=".json" hidden>
    <button onclick="openChangePassword()">Change Password</button>
    <button class="danger" onclick="logout()">Logout</button>
  </div>
</div>

<!-- ADD PEER -->
<div class="card">
  <h2>Add Peer</h2>
  <div class="row">
    <input id="newName" placeholder="Peer name">
    <input id="newIPs" placeholder="Allowed IPs (comma)">
    <button class="ok" onclick="addPeer()">Add</button>
  </div>
</div>

<!-- PEERS -->
<div class="card">
  <h2>Peers</h2>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Allowed IPs</th>
        <th>Status</th>
        <th>Traffic</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="peersBody"></tbody>
  </table>
  <div id="pagination" style="margin-top:10px;text-align:center"></div>

</div>

<!-- EDIT POPUP -->
<div id="editPopup" class="popup">
  <div class="popup-box" style="width:420px">
    <h3>Edit Peer</h3>

    <input type="hidden" id="editOldName">

    <label>Name</label>
    <input id="editName" style="width:100%">

    <label style="margin-top:8px">Allowed IPs</label>
    <textarea id="editIPs" rows="2" style="width:100%"></textarea>

    <hr style="margin:10px 0;border-color:#1e293b">

    <label>Public Key</label>
    <textarea id="editPublicKey" rows="2" style="width:100%"></textarea>

    <label>Private Key</label>
<div style="position:relative">
  <textarea
    id="editPrivateKey"
    rows="2"
    style="width:100%; padding-right:30px"
  ></textarea>

  <input
    type="password"
    id="editPrivateKeyHidden"
    style="display:none"
  >
</div>

<label style="display:block;margin-top:4px">
  <input type="checkbox" id="toggleEditPrivateKey"
         onchange="toggleEditPrivateKeyVisibility()">
  Show Private Key
</label>


    <div class="row" style="margin-top:6px">
      <button onclick="generateKeys()">Generate Keys</button>
    </div>

    <hr style="margin:10px 0;border-color:#1e293b">

    <div class="row">
      <button onclick="showClientConfig()">Show Config</button>
      <button onclick="downloadClientConfig()">Download Config</button>
    </div>

    <div style="margin-top:12px;text-align:right">
      <button onclick="closeEdit()">Cancel</button>
      <button class="ok" onclick="saveEdit()">OK</button>
    </div>
  </div>
</div>

<!-- CLIENT CONFIG POPUP -->
<div id="configPopup" class="popup">
  <div class="popup-box" style="width:480px">
    <h3>Client Configuration</h3>

    <pre id="configView" style="
      background:#020617;
      border:1px solid #1e293b;
      padding:10px;
      font-size:13px;
      overflow:auto;
      max-height:300px;
      white-space:pre-wrap;
    "></pre>

    <label style="display:block;margin-top:8px">
      <input type="checkbox" id="togglePrivateKey" onchange="renderConfig()">
      Show Private Key
    </label>

    <div style="margin-top:12px;text-align:right">
      <button onclick="copyConfig()">Copy</button>
      <button onclick="closeConfig()">Close</button>
    </div>
  </div>
</div>

<!-- CHANGE PASSWORD POPUP -->
<div id="passwordPopup" class="popup">
  <div class="popup-box" style="width:360px">
    <h3>Change Password</h3>

    <input id="oldPass" type="password" placeholder="Old password">
    <input id="newPass" type="password" placeholder="New password">
    <input id="newPass2" type="password" placeholder="Confirm new password">

    <div style="margin-top:12px;text-align:right">
      <button onclick="closeChangePassword()">Cancel</button>
      <button class="ok" onclick="changePassword()">Change</button>
    </div>
  </div>
</div>

<script>
const API = "";
let currentPage = 1;
const pageSize = 20;
let allPeers = [];
let selectedPeerForConfig = null;

const peersBody = document.getElementById("peersBody");

async function api(url, method="GET", body){
  const r = await fetch(API+url,{
    method,
    headers:{ "Content-Type":"application/json" },
    body: body ? JSON.stringify(body):null
  });
  return r.json();
}

/* SERVER */
let serverInfo = null;

async function loadServerInfo(){
  if(serverInfo) return serverInfo;

  const r = await fetch("/api/server");
  serverInfo = await r.json();
  return serverInfo;
}

async function loadServer(){
  const s = await api("/api/server/status");
  serverStatus.innerHTML = `
    <b>Interface:</b> ${s.interface}<br>
    <b>Status:</b> ${s.service}<br>
    <b>Port:</b> ${s.listenPort}<br>
    <b>Peers:</b> ${s.peers}
  `;
}
async function restartServer(){
  if(confirm("Restart WireGuard server?")){
    await api("/api/server/restart","POST");
    loadServer();
  }
}
async function rotateServerKeys(){
  if(confirm("Rotate SERVER keys? Clients must be updated!")){
    await api("/api/server/keys","PUT",{rotate:true});
    loadServer();
  }
}

/* PEERS */
async function loadPeers(){
  allPeers = await api("/api/peers");
  currentPage = 1;
  renderPeers();
}

function renderPeers(){
  const start = (currentPage - 1) * pageSize;
  const pagePeers = allPeers.slice(start, start + pageSize);

  peersBody.innerHTML = "";
  pagePeers.forEach(p => addPeerRow(p));

  renderPagination();
}

function addPeerRow(p){
  const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p.name}</td>
      <td>${p.ips.join("<br>")}</td>
      <td>${p.disabled?"‚ùå Disabled":"‚úÖ Active"}</td>
      <td class="muted">
        ${p.status?.transfer||"-"}<br>
        ${p.status?.handshake||""}
      </td>
      <td>
        <button onclick='openEdit(${JSON.stringify(p)})'>Show/Edit</button>
        ${p.disabled
          ? `<button class="ok" onclick="enablePeer('${p.name}')">Enable</button>`
          : `<button class="warn" onclick="disablePeer('${p.name}')">Disable</button>`
        }
        <button class="danger" onclick="deletePeer('${p.name}')">Delete</button>
      </td>
    `;
    peersBody.appendChild(tr);
}


function renderPagination(){
  const totalPages = Math.ceil(allPeers.length / pageSize);
  const el = document.getElementById("pagination");

  if(totalPages <= 1){
    el.innerHTML = "";
    return;
  }

  el.innerHTML = `
    <button ${currentPage===1?"disabled":""}
      onclick="gotoPage(${currentPage-1})">Prev</button>

    Page ${currentPage} / ${totalPages}

    <button ${currentPage===totalPages?"disabled":""}
      onclick="gotoPage(${currentPage+1})">Next</button>
  `;
}

function gotoPage(p){
  currentPage = p;
  renderPeers();
}



async function addPeer(){
  const name=newName.value.trim();
  const ips=newIPs.value.split(",").map(i=>i.trim()).filter(Boolean);
  if(!name||!ips.length) return alert("Name & IPs required");
  await api("/api/peers","POST",{name,ips});
  newName.value=""; newIPs.value="";
  loadPeers();
}

async function disablePeer(n){ await api(`/api/peers/${n}/disable`,"POST"); loadPeers(); }
async function enablePeer(n){ await api(`/api/peers/${n}/enable`,"POST"); loadPeers(); }
async function deletePeer(n){
  if(confirm(`Delete ${n}?`)){
    await api(`/api/peers/${n}`,"DELETE");
    loadPeers();
  }
}

/* EDIT */
function openEdit(p){
  editOldName.value = p.name;
  editName.value = p.name;
  editIPs.value = p.ips.join(", ");
  editPublicKey.value = p.publicKey || "";
  editPrivateKey.value = p.privateKey || "";

  toggleEditPrivateKey.checked = false;
  editPrivateKey.style.webkitTextSecurity = "disc";

  editPopup.style.display = "block";
}


async function generateKeys(){
  const ok = confirm(
    "Generate new key pair?\n\n" +
    "‚ö† This will invalidate the existing WireGuard connection " +
    "until the peer config is updated."
  );

  if(!ok) return;

  const r = await fetch("/api/genkey", { method:"POST" });
  const d = await r.json();

  editPrivateKey.value = d.privateKey;
  editPublicKey.value = d.publicKey;

  toggleEditPrivateKey.checked = false;
  editPrivateKey.style.webkitTextSecurity = "disc";
}




function closeEdit(){ editPopup.style.display="none"; }

async function saveEdit(){
  const oldName = editOldName.value;
  const name = editName.value.trim();
  const ips = editIPs.value.split(",").map(i=>i.trim()).filter(Boolean);
  const publicKey = editPublicKey.value.trim();
  const privateKey = editPrivateKey.value.trim();

  if(!name || !ips.length) return alert("Name & IPs required");
  if(!publicKey || !privateKey) return alert("Keys required");

  await api(`/api/peers/${oldName}`,"PUT",{
    name,
    ips,
    publicKey,
    privateKey
  });

  closeEdit();
  loadPeers();
}


function buildClientConfig(showPrivate=false){
  const server = serverInfo ;
  const priv = showPrivate
    ? editPrivateKey.value
    : "************ HIDDEN ************";

  return `

[Interface]
PrivateKey = ${priv}
Address = ${editIPs.value.split(",")[0].trim()}

[Peer]
PublicKey = ${server.publicKey}
Endpoint = ${server.hostname}:${server.listenPort}
AllowedIPs = ${server.network}
PersistentKeepalive = 25
`.trim();
}


function showClientConfig(){
  document.getElementById("togglePrivateKey").checked = false;
  renderConfig();
  document.getElementById("configPopup").style.display = "block";
}

function renderConfig(){
  const show = document.getElementById("togglePrivateKey").checked;
  document.getElementById("configView").textContent =
    buildClientConfig(show);
}

function copyConfig(){
  const text = buildClientConfig(true);

  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position = "fixed";
  ta.style.opacity = "0";
  document.body.appendChild(ta);
  ta.select();
  document.execCommand("copy");
  document.body.removeChild(ta);

  alert("Config copied to clipboard");
}


function closeConfig(){
  document.getElementById("configPopup").style.display = "none";
}

function downloadClientConfig(){
  const cfg = buildClientConfig();
  const blob = new Blob([cfg], { type:"text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `${editName.value}.conf`;
  a.click();
}

function toggleEditPrivateKeyVisibility() {
  const show = document.getElementById("toggleEditPrivateKey").checked;
  const textarea = document.getElementById("editPrivateKey");

  textarea.style.webkitTextSecurity = show ? "none" : "disc";
}

/* CHANGE PASSWORD */

async function changePassword(){
  if(newPass.value.length < 6)
    return alert("Password too short");

  const r = await fetch("/api/change-password",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      oldPassword: oldPass.value,
      newPassword: newPass.value
    })
  });

  if(r.ok){
    alert("Password changed");
    oldPass.value = newPass.value = "";
  } else {
    alert("Wrong old password");
  }
}

async function logout(){
  await fetch("/api/logout",{method:"POST"});
  location.href="/login.html";
}

function openChangePassword(){
  passwordPopup.style.display="block";
}

function closeChangePassword(){
  passwordPopup.style.display="none";
  oldPass.value = newPass.value = newPass2.value = "";
}

async function changePassword(){
  if(newPass.value.length < 6)
    return alert("Password too short");

  if(newPass.value !== newPass2.value)
    return alert("Passwords do not match");

  const r = await fetch("/api/change-password",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      oldPassword: oldPass.value,
      newPassword: newPass.value
    })
  });

  if(r.ok){
    alert("Password changed");
    closeChangePassword();
  } else {
    alert("Wrong old password");
  }
}

/* backup restore */
function downloadPeerBackup(){
  window.location.href = "/api/peers/backup";
}

function restorePeerBackup(){
  if(!confirm("This will overwrite ALL peer data. Continue?")) return;
  document.getElementById("peerRestoreFile").click();
}

document.getElementById("peerRestoreFile").onchange = async function(){
  const f = this.files[0];
  if(!f) return;

  const fd = new FormData();
  fd.append("backup", f);

  const res = await fetch("/api/peers/restore",{
    method:"POST",
    body: fd
  });

  const r = await res.json();

  if(!res.ok){
    alert(r.error || "Restore failed");
    return;
  }

  alert(`Restore success: ${r.count} peers loaded`);
  loadPeers(); // refresh table
};

/* INIT */
fetch("/api/peers").then(r=>{
  if(r.status === 401) location.href="/login.html";
});

loadServer();
loadPeers();
loadServerInfo();
setInterval(loadPeers,5000);
</script>

</body>
</html>
